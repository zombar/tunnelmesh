# =============================================================================
# TunnelMesh Server Configuration
# =============================================================================
# Complete reference for all coordinator options.
# Generate a minimal config with: tunnelmesh init --server
#
# Quick start:
#   1. Copy this file to server.yaml
#   2. Set a secure auth_token
#   3. Run: tunnelmesh serve --config server.yaml
# =============================================================================

# -----------------------------------------------------------------------------
# Core Settings
# -----------------------------------------------------------------------------

# Listen address for the coordination server
# Default: ":8443" (HTTPS when join_mesh is configured, otherwise HTTP on :8080)
listen: ":8443"

# Authentication token - peers must provide this to register
# Generate a secure token: openssl rand -hex 32
auth_token: "your-secure-token-here"

# Log level: trace, debug, info, warn, error
# Use "debug" or "trace" for troubleshooting
log_level: "info"

# -----------------------------------------------------------------------------
# Admin Web Interface
# -----------------------------------------------------------------------------
# The admin dashboard shows mesh status, peers, traffic statistics, and
# per-peer transport controls. Access is controlled by network exposure.
#
# Security model:
#   - Default (no join_mesh): HTTP on 127.0.0.1:8080 (localhost only)
#   - With join_mesh: HTTPS on mesh IP only (peers can access)
#   - With mesh_only_admin: false: HTTP on bind_address (exposed!)
#
# For external access, place behind an authenticated reverse proxy.

admin:
  enabled: true
  # bind_address: "127.0.0.1"  # Default: localhost only
  # port: 8080                 # Default: 8080 (or 443 with join_mesh)
  # mesh_only_admin: true      # Only serve admin on mesh IP (default with join_mesh)

# -----------------------------------------------------------------------------
# WebSocket Relay
# -----------------------------------------------------------------------------
# Fallback transport for peers that can't establish direct connections.
# Used when UDP hole-punching and SSH both fail.

relay:
  enabled: true
  pair_timeout: "90s"          # Timeout for peer pairing handshake

# -----------------------------------------------------------------------------
# S3-Compatible Object Storage
# -----------------------------------------------------------------------------
# Built-in S3 storage for mesh data. Supports buckets, objects, and user RBAC.
# First user to register becomes admin.

s3:
  enabled: true
  max_size: "10Gi"             # Storage quota (required, e.g., 10Gi, 500Mi, 1Ti)
  # data_dir: "/var/lib/tunnelmesh/s3"  # Storage directory
  # port: 9000                 # S3 API port

# -----------------------------------------------------------------------------
# Packet Filter (Global Rules)
# -----------------------------------------------------------------------------
# Firewall rules pushed to all peers on connect. Per-peer rules can be
# configured in peer configs or via the admin UI.
#
# Rule priority (most restrictive wins):
#   1. Coordinator global rules (this section)
#   2. Peer config rules
#   3. CLI/admin panel rules
#   4. Auto-generated service port rules

# filter:
#   default_deny: true         # Block all ports unless explicitly allowed
#   rules:
#     - port: 22
#       protocol: tcp
#       action: allow          # Allow SSH mesh-wide
#     - port: 3306
#       protocol: tcp
#       action: deny
#       source_peer: untrusted # Block specific peer from MySQL

# Service ports auto-allowed on all peers (for Prometheus scraping, etc.)
service_ports: [9443]

# -----------------------------------------------------------------------------
# Node Location Tracking
# -----------------------------------------------------------------------------
# Show geographic locations of peers on the admin dashboard map.
# WARNING: Queries ip-api.com to geolocate nodes by public IP.

locations: false

# -----------------------------------------------------------------------------
# WireGuard Concentrator
# -----------------------------------------------------------------------------
# Allow mobile devices and standard WireGuard clients to connect to the mesh.
# Manage clients via the admin panel with QR codes for easy setup.

# wireguard:
#   enabled: true
#   listen_port: 51820
#   endpoint: "server.example.com:51820"  # Public endpoint for clients
#   data_dir: "/var/lib/tunnelmesh/wireguard"

# -----------------------------------------------------------------------------
# Server as Mesh Peer (All-in-One Deployment)
# -----------------------------------------------------------------------------
# The coordinator can also participate as a mesh node. This enables:
#   - HTTPS admin UI accessible only from within the mesh
#   - The coordinator as an exit node for internet traffic
#   - Direct peer-to-peer connectivity from the coordinator
#
# When enabled, admin is served at https://this.tunnelmesh/
# Trust the CA first: tunnelmesh trust-ca --server https://your-coordinator:8443

join_mesh:
  name: "coordinator"          # Mesh hostname (coordinator.tunnelmesh)
  ssh_port: 2222               # SSH server for incoming peer connections
  private_key: "~/.tunnelmesh/id_ed25519"

  tun:
    name: "tun-mesh0"          # TUN interface name
    mtu: 1400                  # MTU for mesh traffic

  dns:
    enabled: true
    listen: "127.0.0.53:5353"  # Local DNS server
    cache_ttl: 300             # DNS cache TTL in seconds
    aliases:                   # Additional DNS names for this node
      - "coordinator"          # coordinator.tunnelmesh -> this node

  # Exit node settings
  allow_exit_traffic: true     # Allow peers to route internet through this node

  # Manual location (overrides IP geolocation)
  # location:
  #   latitude: 52.3676
  #   longitude: 4.9041
  #   city: "Amsterdam"
  #   country: "Netherlands"

  # WireGuard concentrator on this peer
  # wireguard:
  #   enabled: true
  #   listen_port: 51820
  #   endpoint: "server.example.com:51820"
  #   data_dir: "/var/lib/tunnelmesh/wireguard"
